// ============================================================================
// Zellij Configuration
// Migrated from WezTerm - Terminal Multiplexer
// ============================================================================

// ============================================================================
// THEME & APPEARANCE
// ============================================================================

// Use compact layout (single bar at bottom with tabs + status)
default_layout "compact"

// Catppuccin Mocha theme with custom dimming
theme "catppuccin-mocha-custom"

// Simplified UI mode (hide tips and unnecessary UI elements)
simplified_ui true

// Pane frames around splits (enabled for dimming, minimal styling)
pane_frames true

// Enable styled underlines for better visual feedback
styled_underlines true

// Auto layout mode (automatically organize panes)
auto_layout true

// ============================================================================
// BEHAVIOR
// ============================================================================

// Mouse support
mouse_mode true

// Scrollback buffer (10000 lines to match Ghostty/WezTerm)
scroll_buffer_size 10000

// Copy on selection
copy_on_select true

// Copy command
{{ if eq .chezmoi.os "darwin" -}}
copy_command "pbcopy"
{{ else -}}
copy_command "wl-copy"
{{ end -}}

// Mirror session when attaching to existing session
mirror_session false

// Session serialization for persistence
session_serialization true

// ============================================================================
// KEY BINDINGS
// Using Ctrl+a as leader key (matching WezTerm convention)
// ============================================================================

keybinds clear-defaults=true {
    // -------------------------------------------------------------------------
    // NORMAL MODE (default mode)
    // -------------------------------------------------------------------------
    normal {
        // Leader key: Ctrl+a enters "tmux" mode for sub-commands
        bind "Ctrl a" { SwitchToMode "tmux"; }

    }

    // -------------------------------------------------------------------------
    // TMUX MODE (Leader key activated: Ctrl+a)
    // -------------------------------------------------------------------------
    tmux {
        // Return to normal mode after command or on Esc
        bind "Esc" { SwitchToMode "normal"; }
        bind "Ctrl c" { SwitchToMode "normal"; }

        // ----- Tab Operations -----
        bind "c" { NewTab; SwitchToMode "normal"; }
        bind "&" { CloseTab; SwitchToMode "normal"; }
        bind "," { SwitchToMode "RenameTab"; TabNameInput 0; }
        bind "." {
            Run "sh" "-c" "zellij action rename-tab $(basename \"$PWD\")" {
                cwd "/"
            }
            SwitchToMode "normal";
        }
        bind "Tab" { GoToNextTab; SwitchToMode "normal"; }
        bind "Shift Tab" { GoToPreviousTab; SwitchToMode "normal"; }

        // Direct tab access (0-9)
        bind "0" { GoToTab 1; SwitchToMode "normal"; }
        bind "1" { GoToTab 1; SwitchToMode "normal"; }
        bind "2" { GoToTab 2; SwitchToMode "normal"; }
        bind "3" { GoToTab 3; SwitchToMode "normal"; }
        bind "4" { GoToTab 4; SwitchToMode "normal"; }
        bind "5" { GoToTab 5; SwitchToMode "normal"; }
        bind "6" { GoToTab 6; SwitchToMode "normal"; }
        bind "7" { GoToTab 7; SwitchToMode "normal"; }
        bind "8" { GoToTab 8; SwitchToMode "normal"; }
        bind "9" { GoToTab 9; SwitchToMode "normal"; }

        // ----- Pane Operations -----
        bind "v" { NewPane "Right"; SwitchToMode "normal"; }
        bind "h" { NewPane "Down"; SwitchToMode "normal"; }
        bind "x" { CloseFocus; SwitchToMode "normal"; }
        bind "m" { ToggleFocusFullscreen; SwitchToMode "normal"; }  // Maximize pane
        bind "f" { ToggleFloatingPanes; SwitchToMode "normal"; }
        bind "Space" { TogglePaneEmbedOrFloating; SwitchToMode "normal"; }

        // ----- Pane Navigation -----
        bind "Left" { MoveFocus "Left"; SwitchToMode "normal"; }
        bind "Right" { MoveFocus "Right"; SwitchToMode "normal"; }
        bind "Up" { MoveFocus "Up"; SwitchToMode "normal"; }
        bind "Down" { MoveFocus "Down"; SwitchToMode "normal"; }

        // Cycle through panes (w = move mode, p = pane mode)
        bind "w" { SwitchToMode "move"; }
        bind "p" { SwitchToMode "pane"; }

        // ----- UI & Search -----
        bind "[" { SwitchToMode "scroll"; }
        bind "/" { SwitchToMode "search"; }
        bind "r" { SwitchToMode "resize"; }

        // ----- Process Output Management -----
        bind "e" { EditScrollback; SwitchToMode "normal"; }
        bind "Shift s" { ToggleActiveSyncTab; SwitchToMode "normal"; }
        bind "Shift d" {
            Run "sh" "-c" "zellij action dump-screen /tmp/zellij-dump-$(date +%Y%m%d-%H%M%S).txt && echo 'Screen dumped to /tmp'" {
                cwd "/"
            }
            SwitchToMode "normal";
        }

        // ----- Session Management -----
        bind "d" { Detach; }
        bind "k" { Quit; }

        // ----- Plugin Shortcuts -----
        // Pane picker - quickly switch between panes with fuzzy search
        // - Type to search (fuzzy matches across tab name, pane ID, and title)
        // - Up/Down or Ctrl+p/Ctrl+n to navigate
        // - Enter to switch to selected pane
        // - Space to star/unstar panes
        // - Esc to close
        bind "b" {
            LaunchOrFocusPlugin "file:{{ .chezmoi.homeDir }}/.config/zellij/plugins/zellij-pane-picker.wasm" {
                floating true
                move_to_focused_tab true
            }
            SwitchToMode "normal";
        }

        // Session switcher - hierarchical view of all sessions/tabs/panes
        // - Navigate with j/k or arrows, expand/collapse with h/l
        // - Quick jump with 1-9, A-Z shortcuts
        // - Delete sessions with 'x'
        // - Enter to switch to selected session/tab/pane
        bind "s" {
            LaunchOrFocusPlugin "file:{{ .chezmoi.homeDir }}/.config/zellij/plugins/zellij-choose-tree.wasm" {
                floating true
                move_to_focused_tab true
                show_plugins false
            }
            SwitchToMode "normal";
        }

        // Keybind helper (forgot) - show available keybindings
        bind "?" {
            LaunchOrFocusPlugin "file:{{ .chezmoi.homeDir }}/.config/zellij/plugins/zellij-forgot.wasm" {
                floating true
            }
            SwitchToMode "normal";
        }

        // Manual lock mode
        bind "l" { SwitchToMode "locked"; }
    }

    // -------------------------------------------------------------------------
    // MOVE MODE (Pane swapping, triggered by Ctrl+a w)
    // -------------------------------------------------------------------------
    move {
        bind "Esc" { SwitchToMode "normal"; }
        bind "Ctrl c" { SwitchToMode "normal"; }
        bind "Enter" { SwitchToMode "normal"; }

        bind "Left" { MovePane "Left"; }
        bind "Right" { MovePane "Right"; }
        bind "Up" { MovePane "Up"; }
        bind "Down" { MovePane "Down"; }
        bind "n" { MovePane; }
        bind "p" { MovePaneBackwards; }
        bind "Tab" { MovePane; }
    }

    // -------------------------------------------------------------------------
    // PANE MODE (Pane selection, triggered by Ctrl+a Shift+p)
    // -------------------------------------------------------------------------
    pane {
        bind "Esc" { SwitchToMode "normal"; }
        bind "Ctrl c" { SwitchToMode "normal"; }
        bind "Enter" { SwitchToMode "normal"; }

        bind "Left" { MoveFocus "Left"; }
        bind "Right" { MoveFocus "Right"; }
        bind "Up" { MoveFocus "Up"; }
        bind "Down" { MoveFocus "Down"; }

        bind "n" { NewPane; SwitchToMode "normal"; }
        bind "x" { CloseFocus; SwitchToMode "normal"; }
        bind "z" { ToggleFocusFullscreen; SwitchToMode "normal"; }
        bind "r" { TogglePaneFrames; SwitchToMode "normal"; }
    }

    // -------------------------------------------------------------------------
    // SCROLL MODE (Scrollback, triggered by Ctrl+a [)
    // -------------------------------------------------------------------------
    scroll {
        bind "Esc" { SwitchToMode "normal"; }
        bind "Ctrl c" { SwitchToMode "normal"; }
        bind "q" { SwitchToMode "normal"; }
        bind "Enter" { SwitchToMode "normal"; }

        bind "j" "Down" { ScrollDown; }
        bind "k" "Up" { ScrollUp; }
        bind "Ctrl f" "PageDown" { PageScrollDown; }
        bind "Ctrl b" "PageUp" { PageScrollUp; }
        bind "d" { HalfPageScrollDown; }
        bind "u" { HalfPageScrollUp; }
        bind "g" { ScrollToTop; }
        bind "Shift g" { ScrollToBottom; }

        // Search in scroll mode
        bind "/" { SwitchToMode "search"; }
    }

    // -------------------------------------------------------------------------
    // SEARCH MODE (Find in scrollback, triggered by Ctrl+a f)
    // -------------------------------------------------------------------------
    search {
        bind "Esc" { ScrollToBottom; SwitchToMode "normal"; }
        bind "Ctrl c" { ScrollToBottom; SwitchToMode "normal"; }
        bind "Enter" { SwitchToMode "scroll"; }

        bind "n" { Search "down"; }
        bind "p" { Search "up"; }
        bind "Shift n" { Search "up"; }

        bind "c" { SearchToggleOption "CaseSensitivity"; }
        bind "w" { SearchToggleOption "Wrap"; }
        bind "o" { SearchToggleOption "WholeWord"; }
    }

    // -------------------------------------------------------------------------
    // RESIZE MODE (not bound by default, can be accessed if needed)
    // -------------------------------------------------------------------------
    resize {
        bind "Esc" { SwitchToMode "normal"; }
        bind "Ctrl c" { SwitchToMode "normal"; }
        bind "Enter" { SwitchToMode "normal"; }

        bind "Left" { Resize "Increase Left"; }
        bind "Right" { Resize "Increase Right"; }
        bind "Up" { Resize "Increase Up"; }
        bind "Down" { Resize "Increase Down"; }

        bind "Shift Left" { Resize "Decrease Left"; }
        bind "Shift Right" { Resize "Decrease Right"; }
        bind "Shift Up" { Resize "Decrease Up"; }
        bind "Shift Down" { Resize "Decrease Down"; }

        bind "=" { Resize "Increase"; }
        bind "-" { Resize "Decrease"; }
    }

    // -------------------------------------------------------------------------
    // LOCKED MODE (Disable all Zellij keybindings, pass through to terminal)
    // -------------------------------------------------------------------------
    locked {
        bind "Ctrl a" { SwitchToMode "normal"; }
    }

    // -------------------------------------------------------------------------
    // SHARED ACROSS ALL MODES
    // -------------------------------------------------------------------------
    shared_except "locked" {
        // Quick access to locked mode (Ctrl+g to pass all keys through)
        bind "Ctrl g" { SwitchToMode "locked"; }
    }

    shared_except "normal" "locked" {
        // Always allow returning to normal mode
        bind "Ctrl n" { SwitchToMode "normal"; }
    }
}

// ============================================================================
// PLUGINS
// ============================================================================

// Plugin definitions
plugins {
    zellij-pane-picker location="file:{{ .chezmoi.homeDir }}/.config/zellij/plugins/zellij-pane-picker.wasm" {
        list_panes ""
        plugin_select_down "Ctrl n"
        plugin_select_up "Ctrl p"
    }
}

// Load plugins on startup
load_plugins {
    zellij-pane-picker
}

// ============================================================================
// UI CONFIGURATION
// ============================================================================

ui {
    pane_frames {
        rounded_corners false
        hide_session_name true
    }
}

// ============================================================================
// THEME COLORS - Catppuccin Mocha with dimmed unfocused panes
// ============================================================================

themes {
    catppuccin-mocha-custom {
        text_unselected {
            base 205 214 244
            background 24 24 37
            emphasis_0 250 179 135
            emphasis_1 137 220 235
            emphasis_2 166 227 161
            emphasis_3 245 194 231
        }
        text_selected {
            base 205 214 244
            background 88 91 112
            emphasis_0 250 179 135
            emphasis_1 137 220 235
            emphasis_2 166 227 161
            emphasis_3 245 194 231
        }
        ribbon_selected {
            base 24 24 37
            background 166 227 161
            emphasis_0 243 139 168
            emphasis_1 250 179 135
            emphasis_2 245 194 231
            emphasis_3 137 180 250
        }
        ribbon_unselected {
            base 24 24 37
            background 205 214 244
            emphasis_0 243 139 168
            emphasis_1 205 214 244
            emphasis_2 137 180 250
            emphasis_3 245 194 231
        }
        table_title {
            base 166 227 161
            background 0
            emphasis_0 250 179 135
            emphasis_1 137 220 235
            emphasis_2 166 227 161
            emphasis_3 245 194 231
        }
        table_cell_selected {
            base 205 214 244
            background 88 91 112
            emphasis_0 250 179 135
            emphasis_1 137 220 235
            emphasis_2 166 227 161
            emphasis_3 245 194 231
        }
        table_cell_unselected {
            base 205 214 244
            background 24 24 37
            emphasis_0 250 179 135
            emphasis_1 137 220 235
            emphasis_2 166 227 161
            emphasis_3 245 194 231
        }
        list_selected {
            base 205 214 244
            background 88 91 112
            emphasis_0 250 179 135
            emphasis_1 137 220 235
            emphasis_2 166 227 161
            emphasis_3 245 194 231
        }
        list_unselected {
            base 205 214 244
            background 24 24 37
            emphasis_0 250 179 135
            emphasis_1 137 220 235
            emphasis_2 166 227 161
            emphasis_3 245 194 231
        }
        // Unfocused panes - subtle separator only
        frame_unselected {
            base 69 71 90           // Subtle gray separator line (catppuccin black)
            background 0            // Transparent - background dimming doesn't work
            emphasis_0 250 179 135
            emphasis_1 137 220 235
            emphasis_2 245 194 231
            emphasis_3 0
        }
        // Focused pane - highlighted with colored border
        frame_selected {
            base 137 180 250        // Bright blue border to highlight focus
            background 0            // Transparent background
            emphasis_0 250 179 135
            emphasis_1 137 220 235
            emphasis_2 245 194 231
            emphasis_3 0
        }
        // Special mode (PANE, TAB, etc.) - highlighted with orange border
        frame_highlight {
            base 250 179 135        // Orange border for mode indication
            background 0            // Transparent background
            emphasis_0 245 194 231
            emphasis_1 250 179 135
            emphasis_2 250 179 135
            emphasis_3 250 179 135
        }
        exit_code_success {
            base 166 227 161
            background 0
            emphasis_0 137 220 235
            emphasis_1 24 24 37
            emphasis_2 245 194 231
            emphasis_3 137 180 250
        }
        exit_code_error {
            base 243 139 168
            background 0
            emphasis_0 249 226 175
            emphasis_1 0
            emphasis_2 0
            emphasis_3 0
        }
        multiplayer_user_colors {
            player_1 245 194 231
            player_2 137 180 250
            player_3 0
            player_4 249 226 175
            player_5 137 220 235
            player_6 0
            player_7 243 139 168
            player_8 0
            player_9 0
            player_10 0
        }
    }
}

// ============================================================================
// LAYOUTS
// ============================================================================

// Default layout is handled by the "compact" layout above
// You can define custom layouts here if needed
